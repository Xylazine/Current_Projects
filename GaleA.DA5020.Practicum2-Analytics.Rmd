---
title: "Hospital Data Analytics & Reporting"
author: "Gale, Amanda"
date: "Spring 2025"
subtitle: DA5020 / Practicum II"
output: html_document
---

</br>
  
```{r LoadPackages, echo=F}
# Define a vector of required packages
required_packages <- c("XML", "DBI", "RSQLite", "knitr", "kableExtra")

# Check if each package is installed, and install if necessary
for (pkg in required_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
  suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}
rm(list=ls())
```

```{r, echo=F}
con <- dbConnect(RSQLite::SQLite(), "hospital-beds.sqlitedb")
```

```{r Statements, echo=F}
# Number of facilities
n.fac <- as.integer(dbGetQuery(con, "SELECT count(*) FROM facility"))

# Number of licensed beds
n.beds.lic <- as.integer(dbGetQuery(con, "SELECT sum(ttl_licensed) FROM facility"))

# number of staffed beds
n.staffed <- as.integer(dbGetQuery(con, "SELECT sum(ttl_staffed) FROM facility"))

# percentage of licensed beds that are staffed
p.staffed <-as.integer(dbGetQuery(con, "SELECT round((sum(ttl_staffed) / sum(ttl_licensed)) * 100) FROM facility"))

# facilities with greater than 100 beds
n.g100 <- as.integer(dbGetQuery(con, "SELECT count(*) FROM facility WHERE ttl_staffed > 100"))

# average number of staffed beds among facilities
avg.staffed <- as.integer(dbGetQuery(con, "SELECT round(avg(ttl_staffed)) FROM facility"))
```

We have analyzed `r n.fac` medical institutions having a total of `r n.beds.lic` licensed beds. However, not all beds are staffed. In fact, only `r p.staffed`% of all licensed beds are staffed. There are `r n.g100` institutions that have more than 100 staffed beds. The table below summarizes key information:

```{r Table, echo=F}
cols <- c("Total Number of Institutions",
          "Total Number of Licensed Beds",
          "Total Number of Staffed Beds",
          "Average Number of Staffed Beds")
row <- c(n.fac, n.beds.lic, n.staffed, avg.staffed)
df <- data.frame(
  "A"=NA,
  "B"=NA,
  "C"=NA,
  "D"=NA
)
colnames(df) <- cols
df[1,] <- row

kable(df, align='c', caption="Hospital Bed Statistics") %>% 
  row_spec(0, background="#eafecd") %>% 
  kable_styling("bordered", full_width=F)
```
   
</br> 
</br>
     
The chart below shows the distribution of beds:

```{r BedPie, echo=F}
breakdown <- unlist(dbGetQuery(con, "SELECT sum(ttl_licensed), sum(ttl_census), 
                       sum(ttl_staffed) FROM facility"))
pie(breakdown, labels=c("licensed", "census", "staffed"), col=c("#eafecd", "#d9edf7", "#f9e5ff"), 
    main="Total Number of Beds Across All Hospitals")
```

</br>

The breakdown of beds across the different types of beds is shown below:

```{r BedBreakdownTable, echo=F}
breakdown2 <- dbGetQuery(con, "SELECT category, sum(licensed), sum(census), sum(staffed) 
                         FROM bed_facts JOIN bed_categories ON (bed_facts.catid = bed_categories.catid)
                         GROUP BY bed_facts.catid ORDER BY bed_categories.catid")
cols2 <- c("Bed Type", "Licensed", "Census", "Staffed")
colnames(breakdown2) <- cols2

kable(breakdown2, align='c', caption="Bed Count by Type Across All Hospitals") %>% 
  row_spec(seq(1, nrow(breakdown2), 2),background="#d9edf7") %>% 
  kable_styling(bootstrap_options = c("bordered", "condensed"))
```
  
</br>    
</br>

The top 10 facilities with the most staffed beds are listed below, along with the number of beds:

```{r Top10Facilities, echo=F}
top10.staffed <- dbGetQuery(con, "SELECT name, ttl_staffed FROM facility 
                           ORDER BY ttl_staffed DESC LIMIT 10")
top10.staffed$Rank <- 1:10
top10.staffed <- top10.staffed[,c(3,1,2)]
colnames(top10.staffed) <- c("Rank", "Hospital", "Staffed Beds")

kable(top10.staffed, align='c', caption="Hospitals with Most Staffed Beds") %>%
  row_spec(0, background="#eafecd") %>% 
  kable_styling(bootstrap_options = c("bordered", "condensed"))
```
  
</br>
</br>
    
The table below shows the names of the institutions with the most number of staffed beds per type of bed:

```{r MaxStaffedBedsByType, echo=F}
# GPT used to help with this query
max.beds <- dbGetQuery(con, "WITH ranked_facilities AS (
  SELECT name, category, sum(staffed) as total_staffed, 
  RANK() OVER (PARTITION BY category ORDER BY sum(staffed) DESC) as rnk
  FROM bed_facts JOIN facility ON (bed_facts.imsid = facility.imsid)
  JOIN bed_categories ON (bed_categories.catid = bed_facts.catid)
  GROUP BY category, name
  )
SELECT name AS Hospital, category AS 'Bed Category', total_staffed As 'Staffed Beds'
FROM ranked_facilities
WHERE rnk = 1;")

kable(max.beds, align='c', caption="Top Ranking Hospitals by Bed Type") %>% 
  row_spec(seq(1, nrow(max.beds), 2),background="#f9e5ff") %>% 
  kable_styling(bootstrap_options = c("bordered", "condensed"))
```


```{r echo=F}
dbDisconnect(con)
```


</br>
</br>